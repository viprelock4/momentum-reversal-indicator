// This Pine Script™ v6 indicator is a clone of the Momentum Reversal Indicator (MRI)
// Based on TD Sequential by Tom DeMark, with extensions and multi-timeframe features
// Credits: Larry Williams, Tom DeMark, Tyler Jenks, Martin Armstrong & Kevin O'Dowd
//
// v2 Changes:
//   - Extension labels now show count numbers (1-13) instead of just letters
//   - Setup bar 9 now shows "9" alongside the MRI arrow signal
//   - Warning arrow on bar 8 removed if bar 9 completes (handled via label reuse)
//   - S/R lines now track multiple levels (sell resistance + buy support simultaneously)
//   - S/R lines terminate on opposite setup completion instead of extend.right forever
//   - Breakout lines drawn per S/R level, not just one global line
//   - Status bar matches actual MRI format: "MRI 240 120 30" showing MTF params
//   - MTF display shows count alongside timeframe label (e.g. "1D,1") always, not just at 9
//   - Extension count numbers displayed in matching colors below/above candles
//@version=6
indicator("Momentum Reversal Indicator (MRI) v2", shorttitle="MRI", overlay=true, max_labels_count=500, max_lines_count=500, max_bars_back=500)

// ─── INPUTS ───────────────────────────────────────────────────────────────────

// Display Settings
grpDisplay     = "Display Settings"
showSetupNums  = input.bool(true, "Show Setup Numbers (1-9)", group=grpDisplay)
showWarning    = input.bool(true, "Show Warning Arrow (Orange)", group=grpDisplay)
showSignals    = input.bool(true, "Show MRI Top/Bottom Arrows", group=grpDisplay)
showConsCount  = input.bool(true, "Show Consecutive Count", group=grpDisplay)

// Extension Settings
grpExt         = "Extension Settings"
showExtA       = input.bool(true, "Show Extension A", group=grpExt)
showExtB       = input.bool(true, "Show Extension B", group=grpExt)
showExtC       = input.bool(true, "Show Extension C", group=grpExt)

// Line Settings
grpLines       = "Support / Resistance / Breakout Lines"
showSRLines    = input.bool(true, "Show Support/Resistance Lines", group=grpLines)
showBreakout   = input.bool(true, "Show Breakout Lines", group=grpLines)
srResColor     = input.color(color.new(color.red, 30), "Resistance Line Color", group=grpLines)
srSupColor     = input.color(color.new(color.green, 30), "Support Line Color", group=grpLines)
breakoutColor  = input.color(color.new(color.aqua, 20), "Breakout Line Color", group=grpLines)

// Multi-Timeframe Settings
grpMTF         = "Multi-Timeframe Display"
showMTF        = input.bool(true, "Enable Multi-Timeframe", group=grpMTF)
show1H         = input.bool(true, "Show 1H", group=grpMTF)
show1D         = input.bool(true, "Show 1D", group=grpMTF)
show1W         = input.bool(true, "Show 1W", group=grpMTF)
show1M         = input.bool(true, "Show 1M", group=grpMTF)
show1Y         = input.bool(true, "Show 12M (Yearly)", group=grpMTF)
showCustomTF1  = input.bool(false, "Show Custom TF 1", group=grpMTF)
customTF1      = input.timeframe("240", "Custom TF 1", group=grpMTF)
showCustomTF2  = input.bool(false, "Show Custom TF 2", group=grpMTF)
customTF2      = input.timeframe("120", "Custom TF 2", group=grpMTF)
showCustomTF3  = input.bool(false, "Show Custom TF 3", group=grpMTF)
customTF3      = input.timeframe("30", "Custom TF 3", group=grpMTF)

// Color Settings
grpColors      = "Colors"
sellSetupColor = input.color(color.new(color.red, 0), "Sell Setup Numbers", group=grpColors)
buySetupColor  = input.color(color.new(color.green, 0), "Buy Setup Numbers", group=grpColors)
topArrowColor  = input.color(color.new(color.red, 0), "MRI Top Arrow", group=grpColors)
botArrowColor  = input.color(color.new(color.green, 0), "MRI Bottom Arrow", group=grpColors)
warnColor      = input.color(color.new(color.orange, 0), "Warning Arrow", group=grpColors)
extAColor      = input.color(color.new(color.aqua, 0), "Extension A Color", group=grpColors)
extBColor      = input.color(color.new(color.blue, 0), "Extension B Color", group=grpColors)
extCColor      = input.color(color.new(color.purple, 0), "Extension C Color", group=grpColors)


// ─── TD SETUP PHASE (1-9 COUNT) ──────────────────────────────────────────────

// A sell setup: 9 consecutive closes > close[4]
// A buy setup:  9 consecutive closes < close[4]

var int  setupCount     = 0
var bool isSellSetup    = false
var bool isBuySetup     = false
var int  consecutiveTop = 0
var int  consecutiveBot = 0

// Price flip detection
bullFlip = close > close[4]  // Current close higher than 4 bars ago (sell setup bar)
bearFlip = close < close[4]  // Current close lower than 4 bars ago (buy setup bar)

// Track setup count
if bullFlip
    if isSellSetup
        setupCount := setupCount + 1
    else
        setupCount := 1
        isSellSetup := true
        isBuySetup  := false
else if bearFlip
    if isBuySetup
        setupCount := setupCount + 1
    else
        setupCount := 1
        isBuySetup  := true
        isSellSetup := false
else
    setupCount  := 0
    isSellSetup := false
    isBuySetup  := false

// Detect completed setup (count reaches 9)
sellSetupComplete = isSellSetup and setupCount == 9
buySetupComplete  = isBuySetup  and setupCount == 9

// Track the bar index and price of the 1st candle in each setup for TDST lines
var int   sellSetupBar1Idx  = na
var float sellSetupBar1High = na
var int   buySetupBar1Idx   = na
var float buySetupBar1Low   = na

if isSellSetup and setupCount == 1
    sellSetupBar1Idx  := bar_index
    sellSetupBar1High := high
if isBuySetup and setupCount == 1
    buySetupBar1Idx := bar_index
    buySetupBar1Low := low

// ─── PERFECTION CHECK ────────────────────────────────────────────────────────
// Sell setup perfection: high of bar 8 or 9 >= high of bar 6 AND high of bar 7
// Buy setup perfection:  low of bar 8 or 9 <= low of bar 6 AND low of bar 7

var bool sellPerfected = false
var bool buyPerfected  = false

if sellSetupComplete
    h6 = high[3]  // bar 6 is 3 bars before bar 9
    h7 = high[2]  // bar 7 is 2 bars before bar 9
    h8 = high[1]  // bar 8 is 1 bar before bar 9
    h9 = high
    sellPerfected := (h8 >= h6 and h8 >= h7) or (h9 >= h6 and h9 >= h7)

if buySetupComplete
    l6 = low[3]
    l7 = low[2]
    l8 = low[1]
    l9 = low
    buyPerfected := (l8 <= l6 and l8 <= l7) or (l9 <= l6 and l9 <= l7)


// ─── CONSECUTIVE SIGNAL COUNTING ─────────────────────────────────────────────
// Track how many times in a row we get MRI top/bottom without a reversal

if sellSetupComplete
    consecutiveTop := consecutiveTop + 1
    consecutiveBot := 0
if buySetupComplete
    consecutiveBot := consecutiveBot + 1
    consecutiveTop := 0


// ─── EXTENSION COUNTING (A, B, C) — 13 NON-CONSECUTIVE ──────────────────────

// Extension A: close > high[2] (sell) / close < low[2] (buy)
//              Bar 13 qualifier: close vs close of bar 8
// Extension B: close > close[2] (sell) / close < close[2] (buy)
//              Bar 13 qualifier: high/low vs close of bar 8
// Extension C: Most restrictive — multiple conditions
//              Bar 13 qualifier: same as B

// ─── Extension State Variables ───────────────────────────────────────────────

// Extension A - Sell
var int   extA_sell_count     = 0
var bool  extA_sell_active    = false
var float extA_sell_close8    = na

// Extension A - Buy
var int   extA_buy_count      = 0
var bool  extA_buy_active     = false
var float extA_buy_close8     = na

// Extension B - Sell
var int   extB_sell_count     = 0
var bool  extB_sell_active    = false
var float extB_sell_close8    = na

// Extension B - Buy
var int   extB_buy_count      = 0
var bool  extB_buy_active     = false
var float extB_buy_close8     = na

// Extension C - Sell
var int   extC_sell_count     = 0
var bool  extC_sell_active    = false
var float extC_sell_close8    = na

// Extension C - Buy
var int   extC_buy_count      = 0
var bool  extC_buy_active     = false
var float extC_buy_close8     = na

// S/R levels for extension cancellation
var float activeSellSR = na
var float activeBuySR  = na

// Activate extensions on setup completion
if sellSetupComplete
    extA_sell_count  := 0
    extA_sell_active := true
    extA_sell_close8 := na

    extB_sell_count  := 0
    extB_sell_active := true
    extB_sell_close8 := na

    extC_sell_count  := 0
    extC_sell_active := true
    extC_sell_close8 := na

    activeSellSR := sellSetupBar1High

    // Cancel any active buy extensions on opposite MRI completion
    extA_buy_active := false
    extB_buy_active := false
    extC_buy_active := false

if buySetupComplete
    extA_buy_count  := 0
    extA_buy_active := true
    extA_buy_close8 := na

    extB_buy_count  := 0
    extB_buy_active := true
    extB_buy_close8 := na

    extC_buy_count  := 0
    extC_buy_active := true
    extC_buy_close8 := na

    activeBuySR := buySetupBar1Low

    // Cancel any active sell extensions on opposite MRI completion
    extA_sell_active := false
    extB_sell_active := false
    extC_sell_active := false

// ─── Extension A Logic ───────────────────────────────────────────────────────

// Extension A Sell: close > high[2]
extA_sell_triggered = false
if extA_sell_active and close > high[2]
    extA_sell_count    := extA_sell_count + 1
    extA_sell_triggered := true
    if extA_sell_count == 8
        extA_sell_close8 := close

extA_sell_complete = false
extA_sell_deferred = false
if extA_sell_active and extA_sell_count == 13
    if not na(extA_sell_close8) and close > extA_sell_close8
        extA_sell_complete := true
        extA_sell_active   := false
    else
        extA_sell_deferred := true
        extA_sell_count    := extA_sell_count - 1

// Extension A Buy: close < low[2]
extA_buy_triggered = false
if extA_buy_active and close < low[2]
    extA_buy_count    := extA_buy_count + 1
    extA_buy_triggered := true
    if extA_buy_count == 8
        extA_buy_close8 := close

extA_buy_complete = false
extA_buy_deferred = false
if extA_buy_active and extA_buy_count == 13
    if not na(extA_buy_close8) and close < extA_buy_close8
        extA_buy_complete := true
        extA_buy_active   := false
    else
        extA_buy_deferred := true
        extA_buy_count    := extA_buy_count - 1

// Cancel Extension A if price breaks S/R
if extA_sell_active and not na(activeSellSR) and close < activeSellSR
    extA_sell_active := false
if extA_buy_active and not na(activeBuySR) and close > activeBuySR
    extA_buy_active := false

// ─── Extension B Logic ───────────────────────────────────────────────────────

// Extension B Sell: close > close[2]
extB_sell_triggered = false
if extB_sell_active and close > close[2]
    extB_sell_count    := extB_sell_count + 1
    extB_sell_triggered := true
    if extB_sell_count == 8
        extB_sell_close8 := close

extB_sell_complete = false
extB_sell_deferred = false
if extB_sell_active and extB_sell_count == 13
    if not na(extB_sell_close8) and high >= extB_sell_close8
        extB_sell_complete := true
        extB_sell_active   := false
    else
        extB_sell_deferred := true
        extB_sell_count    := extB_sell_count - 1

// Extension B Buy: close < close[2]
extB_buy_triggered = false
if extB_buy_active and close < close[2]
    extB_buy_count    := extB_buy_count + 1
    extB_buy_triggered := true
    if extB_buy_count == 8
        extB_buy_close8 := close

extB_buy_complete = false
extB_buy_deferred = false
if extB_buy_active and extB_buy_count == 13
    if not na(extB_buy_close8) and low <= extB_buy_close8
        extB_buy_complete := true
        extB_buy_active   := false
    else
        extB_buy_deferred := true
        extB_buy_count    := extB_buy_count - 1

// Cancel Extension B if price breaks S/R
if extB_sell_active and not na(activeSellSR) and close < activeSellSR
    extB_sell_active := false
if extB_buy_active and not na(activeBuySR) and close > activeBuySR
    extB_buy_active := false

// ─── Extension C Logic ───────────────────────────────────────────────────────

// Extension C Sell: close > high[2] AND close > close[1] AND (for count <= 10: high > high[1])
extC_sell_triggered = false
extC_sell_baseCond  = extC_sell_active and close > high[2] and close > close[1]
extC_sell_cond      = extC_sell_baseCond and (extC_sell_count >= 10 or high > high[1])
// First candle exemption: only needs close > high[2]
if extC_sell_active and extC_sell_count == 0 and close > high[2]
    extC_sell_cond := true

if extC_sell_cond
    extC_sell_count    := extC_sell_count + 1
    extC_sell_triggered := true
    if extC_sell_count == 8
        extC_sell_close8 := close

extC_sell_complete = false
extC_sell_deferred = false
if extC_sell_active and extC_sell_count == 13
    if not na(extC_sell_close8) and high >= extC_sell_close8
        extC_sell_complete := true
        extC_sell_active   := false
    else
        extC_sell_deferred := true
        extC_sell_count    := extC_sell_count - 1

// Extension C Buy: close < low[2] AND close < close[1] AND (for count <= 10: low < low[1])
extC_buy_triggered = false
extC_buy_baseCond  = extC_buy_active and close < low[2] and close < close[1]
extC_buy_cond      = extC_buy_baseCond and (extC_buy_count >= 10 or low < low[1])
if extC_buy_active and extC_buy_count == 0 and close < low[2]
    extC_buy_cond := true

if extC_buy_cond
    extC_buy_count    := extC_buy_count + 1
    extC_buy_triggered := true
    if extC_buy_count == 8
        extC_buy_close8 := close

extC_buy_complete = false
extC_buy_deferred = false
if extC_buy_active and extC_buy_count == 13
    if not na(extC_buy_close8) and low <= extC_buy_close8
        extC_buy_complete := true
        extC_buy_active   := false
    else
        extC_buy_deferred := true
        extC_buy_count    := extC_buy_count - 1

// Cancel Extension C if price breaks S/R
if extC_sell_active and not na(activeSellSR) and close < activeSellSR
    extC_sell_active := false
if extC_buy_active and not na(activeBuySR) and close > activeBuySR
    extC_buy_active := false


// ─── SUPPORT / RESISTANCE / BREAKOUT LINES ──────────────────────────────────

// Resistance (dotted): High of first bar in sell setup — drawn on sell setup completion
// Support (dotted):    Low of first bar in buy setup — drawn on buy setup completion
// Breakout (solid):    When price breaks through S/R in the trend direction

// Track separate S/R lines for sell and buy setups
var line sellResLine    = na
var line buySupLine     = na
var line sellBreakLine  = na
var line buyBreakLine   = na
var float lastResLevel  = na
var float lastSupLevel  = na
var bool  resBroken     = false
var bool  supBroken     = false

// Draw resistance line on sell setup completion
if sellSetupComplete and showSRLines
    // Terminate previous resistance line
    if not na(sellResLine)
        line.set_extend(sellResLine, extend.none)
        line.set_x2(sellResLine, bar_index)
    sellResLine := line.new(sellSetupBar1Idx, sellSetupBar1High, bar_index, sellSetupBar1High, color=srResColor, style=line.style_dashed, width=1, extend=extend.right)
    lastResLevel := sellSetupBar1High
    resBroken    := false

// Draw support line on buy setup completion
if buySetupComplete and showSRLines
    // Terminate previous support line
    if not na(buySupLine)
        line.set_extend(buySupLine, extend.none)
        line.set_x2(buySupLine, bar_index)
    buySupLine  := line.new(buySetupBar1Idx, buySetupBar1Low, bar_index, buySetupBar1Low, color=srSupColor, style=line.style_dashed, width=1, extend=extend.right)
    lastSupLevel := buySetupBar1Low
    supBroken    := false

// Breakout: price closes through the S/R level
if showBreakout and not na(lastResLevel) and close > lastResLevel and not resBroken
    sellBreakLine := line.new(bar_index, lastResLevel, bar_index + 1, lastResLevel, color=breakoutColor, style=line.style_solid, width=2, extend=extend.right)
    resBroken     := true
if showBreakout and not na(lastSupLevel) and close < lastSupLevel and not supBroken
    buyBreakLine := line.new(bar_index, lastSupLevel, bar_index + 1, lastSupLevel, color=breakoutColor, style=line.style_solid, width=2, extend=extend.right)
    supBroken    := true

// Terminate breakout lines on new opposite setup
if sellSetupComplete and not na(buyBreakLine)
    line.set_extend(buyBreakLine, extend.none)
    line.set_x2(buyBreakLine, bar_index)
if buySetupComplete and not na(sellBreakLine)
    line.set_extend(sellBreakLine, extend.none)
    line.set_x2(sellBreakLine, bar_index)


// ─── PLOT SETUP NUMBERS (1-9) ───────────────────────────────────────────────

// Show numbers 1-8 during counting, and 9 at completion
// Bar 8: also shows orange warning arrow if enabled (warning disappears if 9 follows)
// Bar 9: shows count "9" + MRI arrow signal

// Warning label on bar 8 (will be visually "replaced" by bar 9 signal on next bar)
isWarning8Sell = isSellSetup and setupCount == 8
isWarning8Buy  = isBuySetup  and setupCount == 8

if showSetupNums and setupCount >= 1 and setupCount <= 8
    lblColor = isSellSetup ? sellSetupColor : buySetupColor
    lblPos   = isSellSetup ? label.style_label_down : label.style_label_up
    yPos     = isSellSetup ? high : low
    label.new(bar_index, yPos, str.tostring(setupCount), color=color.new(color.white, 100), textcolor=lblColor, style=lblPos, size=size.tiny)

// Warning arrow on bar 8 (orange)
if showWarning and isWarning8Sell
    label.new(bar_index, high, "▼", color=color.new(color.white, 100), textcolor=warnColor, style=label.style_label_down, size=size.small)
if showWarning and isWarning8Buy
    label.new(bar_index, low, "▲", color=color.new(color.white, 100), textcolor=warnColor, style=label.style_label_up, size=size.small)


// ─── PLOT MRI TOP / BOTTOM SIGNALS (BAR 9) ─────────────────────────────────

// Bar 9 shows: the number "9" + the MRI arrow + consecutive count if > 1
if sellSetupComplete
    consTxt = showConsCount and consecutiveTop > 1 ? str.tostring(consecutiveTop) + "\n" : ""
    if showSignals
        label.new(bar_index, high, consTxt + "▼\n9", color=color.new(color.white, 100), textcolor=topArrowColor, style=label.style_label_down, size=size.normal)
    else if showSetupNums
        label.new(bar_index, high, "9", color=color.new(color.white, 100), textcolor=sellSetupColor, style=label.style_label_down, size=size.tiny)

if buySetupComplete
    consTxt = showConsCount and consecutiveBot > 1 ? "\n" + str.tostring(consecutiveBot) : ""
    if showSignals
        label.new(bar_index, low, "9\n▲" + consTxt, color=color.new(color.white, 100), textcolor=botArrowColor, style=label.style_label_up, size=size.normal)
    else if showSetupNums
        label.new(bar_index, low, "9", color=color.new(color.white, 100), textcolor=buySetupColor, style=label.style_label_up, size=size.tiny)


// ─── PLOT EXTENSION COUNT LABELS (1-13) ─────────────────────────────────────

// Extension labels show the count number with the extension letter
// e.g. "3" in cyan for Extension A count 3, "B" on completion, "C9" for C count 9

// Helper to build extension label text
extLabel(int count, string letter, bool isComplete) =>
    isComplete ? letter : count <= 13 ? str.tostring(count) : ""

// Extension A — Sell side
if showExtA and extA_sell_triggered and extA_sell_active
    txt = extLabel(extA_sell_count, "A", false)
    label.new(bar_index, high, txt, color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_down, size=size.tiny)
if showExtA and extA_sell_complete
    label.new(bar_index, high, "A", color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_down, size=size.normal)
if showExtA and extA_sell_deferred
    label.new(bar_index, high, "+", color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_down, size=size.tiny)

// Extension A — Buy side
if showExtA and extA_buy_triggered and extA_buy_active
    txt = extLabel(extA_buy_count, "A", false)
    label.new(bar_index, low, txt, color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_up, size=size.tiny)
if showExtA and extA_buy_complete
    label.new(bar_index, low, "A", color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_up, size=size.normal)
if showExtA and extA_buy_deferred
    label.new(bar_index, low, "+", color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_up, size=size.tiny)

// Extension B — Sell side
if showExtB and extB_sell_triggered and extB_sell_active
    txt = extLabel(extB_sell_count, "B", false)
    label.new(bar_index, high, txt, color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_down, size=size.tiny)
if showExtB and extB_sell_complete
    label.new(bar_index, high, "B", color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_down, size=size.normal)
if showExtB and extB_sell_deferred
    label.new(bar_index, high, "+", color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_down, size=size.tiny)

// Extension B — Buy side
if showExtB and extB_buy_triggered and extB_buy_active
    txt = extLabel(extB_buy_count, "B", false)
    label.new(bar_index, low, txt, color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_up, size=size.tiny)
if showExtB and extB_buy_complete
    label.new(bar_index, low, "B", color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_up, size=size.normal)
if showExtB and extB_buy_deferred
    label.new(bar_index, low, "+", color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_up, size=size.tiny)

// Extension C — Sell side
if showExtC and extC_sell_triggered and extC_sell_active
    txt = extLabel(extC_sell_count, "C", false)
    label.new(bar_index, high, txt, color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_down, size=size.tiny)
if showExtC and extC_sell_complete
    label.new(bar_index, high, "C", color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_down, size=size.normal)
if showExtC and extC_sell_deferred
    label.new(bar_index, high, "+", color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_down, size=size.tiny)

// Extension C — Buy side
if showExtC and extC_buy_triggered and extC_buy_active
    txt = extLabel(extC_buy_count, "C", false)
    label.new(bar_index, low, txt, color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_up, size=size.tiny)
if showExtC and extC_buy_complete
    label.new(bar_index, low, "C", color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_up, size=size.normal)
if showExtC and extC_buy_deferred
    label.new(bar_index, low, "+", color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_up, size=size.tiny)


// ─── MULTI-TIMEFRAME MRI ────────────────────────────────────────────────────

// Function to calculate MRI setup count on any timeframe
mriCalc() =>
    _bull = close > close[4]
    _bear = close < close[4]
    var int _count = 0
    var bool _isSell = false
    var bool _isBuy  = false
    var int _consTop = 0
    var int _consBot = 0

    if _bull
        if _isSell
            _count := _count + 1
        else
            _count  := 1
            _isSell := true
            _isBuy  := false
    else if _bear
        if _isBuy
            _count := _count + 1
        else
            _count  := 1
            _isBuy  := true
            _isSell := false
    else
        _count  := 0
        _isSell := false
        _isBuy  := false

    _sellComplete = _isSell and _count == 9
    _buyComplete  = _isBuy  and _count == 9

    if _sellComplete
        _consTop := _consTop + 1
        _consBot := 0
    if _buyComplete
        _consBot := _consBot + 1
        _consTop := 0

    // Return: count, isSell, isBuy, consecutiveTop, consecutiveBot, lastCompleteWasSell
    [_count, _isSell ? 1 : 0, _isBuy ? 1 : 0, _consTop, _consBot]

// Request MTF data
[mtf1h_count, mtf1h_sell, mtf1h_buy, mtf1h_ctop, mtf1h_cbot] = request.security(syminfo.tickerid, "60",  mriCalc())
[mtf1d_count, mtf1d_sell, mtf1d_buy, mtf1d_ctop, mtf1d_cbot] = request.security(syminfo.tickerid, "1D",  mriCalc())
[mtf1w_count, mtf1w_sell, mtf1w_buy, mtf1w_ctop, mtf1w_cbot] = request.security(syminfo.tickerid, "1W",  mriCalc())
[mtf1m_count, mtf1m_sell, mtf1m_buy, mtf1m_ctop, mtf1m_cbot] = request.security(syminfo.tickerid, "1M",  mriCalc())
[mtf1y_count, mtf1y_sell, mtf1y_buy, mtf1y_ctop, mtf1y_cbot] = request.security(syminfo.tickerid, "12M", mriCalc())
[mtfC1_count, mtfC1_sell, mtfC1_buy, mtfC1_ctop, mtfC1_cbot] = request.security(syminfo.tickerid, customTF1, mriCalc())
[mtfC2_count, mtfC2_sell, mtfC2_buy, mtfC2_ctop, mtfC2_cbot] = request.security(syminfo.tickerid, customTF2, mriCalc())
[mtfC3_count, mtfC3_sell, mtfC3_buy, mtfC3_ctop, mtfC3_cbot] = request.security(syminfo.tickerid, customTF3, mriCalc())

// Build MTF display string — always show if a completed signal exists (count == 9)
mtfGetStr(string prefix, int count, int isSell, int isBuy, int consTop, int consBot) =>
    result = ""
    if count == 9
        consVal = isSell == 1 ? consTop : consBot
        result := prefix + "," + str.tostring(consVal)
    result

// Compose the MTF label on the right side of chart
var label mtfLabel = na

if showMTF and barstate.islast
    mtfText = ""

    if show1H
        s = mtfGetStr("1H", mtf1h_count, mtf1h_sell, mtf1h_buy, mtf1h_ctop, mtf1h_cbot)
        if s != ""
            mtfText := mtfText + (mtfText != "" ? "\n" : "") + s

    if show1D
        s = mtfGetStr("1D", mtf1d_count, mtf1d_sell, mtf1d_buy, mtf1d_ctop, mtf1d_cbot)
        if s != ""
            mtfText := mtfText + (mtfText != "" ? "\n" : "") + s

    if show1W
        s = mtfGetStr("1W", mtf1w_count, mtf1w_sell, mtf1w_buy, mtf1w_ctop, mtf1w_cbot)
        if s != ""
            mtfText := mtfText + (mtfText != "" ? "\n" : "") + s

    if show1M
        s = mtfGetStr("1M", mtf1m_count, mtf1m_sell, mtf1m_buy, mtf1m_ctop, mtf1m_cbot)
        if s != ""
            mtfText := mtfText + (mtfText != "" ? "\n" : "") + s

    if show1Y
        s = mtfGetStr("12M", mtf1y_count, mtf1y_sell, mtf1y_buy, mtf1y_ctop, mtf1y_cbot)
        if s != ""
            mtfText := mtfText + (mtfText != "" ? "\n" : "") + s

    if showCustomTF1
        s = mtfGetStr(customTF1, mtfC1_count, mtfC1_sell, mtfC1_buy, mtfC1_ctop, mtfC1_cbot)
        if s != ""
            mtfText := mtfText + (mtfText != "" ? "\n" : "") + s

    if showCustomTF2
        s = mtfGetStr(customTF2, mtfC2_count, mtfC2_sell, mtfC2_buy, mtfC2_ctop, mtfC2_cbot)
        if s != ""
            mtfText := mtfText + (mtfText != "" ? "\n" : "") + s

    if showCustomTF3
        s = mtfGetStr(customTF3, mtfC3_count, mtfC3_sell, mtfC3_buy, mtfC3_ctop, mtfC3_cbot)
        if s != ""
            mtfText := mtfText + (mtfText != "" ? "\n" : "") + s

    if mtfText != ""
        if not na(mtfLabel)
            label.delete(mtfLabel)
        mtfLabel := label.new(bar_index + 3, close, mtfText, color=color.new(color.black, 60), textcolor=color.white, style=label.style_label_left, size=size.normal, textalign=text.align_left)


// ─── STATUS LINE ────────────────────────────────────────────────────────────

// Matches actual MRI format: "MRI 240 120 30" showing the MTF timeframe params
// Followed by setup/extension state info

tfMinutes = timeframe.in_seconds() / 60
mriStatusTF = str.tostring(tfMinutes)

// Build status showing active MTF params (current + custom TFs)
mriStatusLine = "MRI " + mriStatusTF
if showCustomTF1
    mriStatusLine := mriStatusLine + " " + customTF1
if showCustomTF2
    mriStatusLine := mriStatusLine + " " + customTF2
if showCustomTF3
    mriStatusLine := mriStatusLine + " " + customTF3

plot(na, title=mriStatusLine, display=display.status_line, editable=false)


// ─── ALERTS ─────────────────────────────────────────────────────────────────

alertcondition(sellSetupComplete, title="MRI Top", message="MRI Top signal — Bullish trend may be ending")
alertcondition(buySetupComplete, title="MRI Bottom", message="MRI Bottom signal — Bearish trend may be ending")
alertcondition(isWarning8Sell, title="MRI Warning (Sell)", message="MRI Warning — Potential top on next candle")
alertcondition(isWarning8Buy, title="MRI Warning (Buy)", message="MRI Warning — Potential bottom on next candle")
alertcondition(extA_sell_complete or extA_buy_complete, title="Extension A Complete", message="MRI Extension A completed")
alertcondition(extB_sell_complete or extB_buy_complete, title="Extension B Complete", message="MRI Extension B completed")
alertcondition(extC_sell_complete or extC_buy_complete, title="Extension C Complete", message="MRI Extension C completed")
alertcondition(consecutiveTop >= 2 and sellSetupComplete, title="Consecutive MRI Top", message="Consecutive MRI Top — Strong reversal signal")
alertcondition(consecutiveBot >= 2 and buySetupComplete, title="Consecutive MRI Bottom", message="Consecutive MRI Bottom — Strong reversal signal")
