// This Pine Script™ v6 indicator is a clone of the Momentum Reversal Indicator (MRI)
// Based on TD Sequential by Tom DeMark, with extensions and multi-timeframe features
// Credits: Larry Williams, Tom DeMark, Tyler Jenks, Martin Armstrong & Kevin O'Dowd
//
// v5 Changes:
//   - RESTORED: Orange warning arrow on bar 8 (disappears when bar 9 completes)
//   - IMPROVED: Proper filled triangle arrows via plotshape() for MRI Top/Bottom signals
//   - ADDED: Combined "C9" notation when extension count coincides with setup bar 9
//   - IMPROVED: MTF display as table at bottom-right matching original MRI layout
//   - IMPROVED: Extension numbers displayed alongside setup numbers on same bar
//   - IMPROVED: Visual style closer to original MRI (colors, sizing, positioning)
//@version=6
indicator("Momentum Reversal Indicator (MRI) v5", shorttitle="MRI v5", overlay=true, max_labels_count=500, max_lines_count=500, max_bars_back=500)

// ─── INPUTS ───────────────────────────────────────────────────────────────────

grpDisplay     = "Display Settings"
showSetupNums  = input.bool(true, "Show Setup Numbers", group=grpDisplay)
showSignals    = input.bool(true, "Show MRI Top/Bottom Arrows", group=grpDisplay)
showWarning    = input.bool(true, "Show Orange Warning on Bar 8", group=grpDisplay)
showConsCount  = input.bool(true, "Show Consecutive Count", group=grpDisplay)

grpExt         = "Extension Settings"
extMode        = input.string("All", "Extension Display", options=["All", "A", "B", "C", "B & C", "None"], group=grpExt)

grpLines       = "Support / Resistance / Breakout Lines"
showSRLines    = input.bool(true, "Show Support/Resistance Lines", group=grpLines)
showBreakout   = input.bool(true, "Show Breakout Lines", group=grpLines)
maxLines       = input.int(4, "Max S/R Lines Visible", minval=1, maxval=20, group=grpLines)

grpMTF         = "Multi-Timeframe Display"
showMTF        = input.bool(true, "Enable Multi-Timeframe", group=grpMTF)
show1H         = input.bool(false, "Show 1H", group=grpMTF)
show1D         = input.bool(true, "Show 1D", group=grpMTF)
show1W         = input.bool(true, "Show 1W", group=grpMTF)
show1M         = input.bool(true, "Show 1M", group=grpMTF)
show1Y         = input.bool(false, "Show 12M (Yearly)", group=grpMTF)
showCustomTF1  = input.bool(false, "Show Custom TF 1", group=grpMTF)
customTF1      = input.timeframe("240", "Custom TF 1", group=grpMTF)
showCustomTF2  = input.bool(false, "Show Custom TF 2", group=grpMTF)
customTF2      = input.timeframe("120", "Custom TF 2", group=grpMTF)
showCustomTF3  = input.bool(false, "Show Custom TF 3", group=grpMTF)
customTF3      = input.timeframe("30", "Custom TF 3", group=grpMTF)

// Derived extension visibility
showExtA = extMode == "All" or extMode == "A"
showExtB = extMode == "All" or extMode == "B" or extMode == "B & C"
showExtC = extMode == "All" or extMode == "C" or extMode == "B & C"

// Colors
color sellNumColor   = color.red
color buyNumColor    = #00CC00
color topArrowColor  = color.red
color botArrowColor  = #00CC00
color warnColor      = color.orange
color srResColor     = color.red
color srSupColor     = #00CC00
color breakoutColorC = #0099FF
color extAColor      = #00CCCC
color extBColor      = #3399FF
color extCColor      = #CC66FF


// ─── TD SETUP PHASE (1-9 COUNT) ──────────────────────────────────────────────

var int  setupCount     = 0
var bool isSellSetup    = false
var bool isBuySetup     = false
var int  consecutiveTop = 0
var int  consecutiveBot = 0

bullFlip = close > close[4]
bearFlip = close < close[4]

if bullFlip
    if isSellSetup
        setupCount := setupCount + 1
    else
        setupCount := 1
        isSellSetup := true
        isBuySetup  := false
else if bearFlip
    if isBuySetup
        setupCount := setupCount + 1
    else
        setupCount := 1
        isBuySetup  := true
        isSellSetup := false
else
    setupCount  := 0
    isSellSetup := false
    isBuySetup  := false

sellSetupComplete = isSellSetup and setupCount == 9
buySetupComplete  = isBuySetup  and setupCount == 9

var int   sellSetupBar1Idx  = na
var float sellSetupBar1High = na
var int   buySetupBar1Idx   = na
var float buySetupBar1Low   = na

if isSellSetup and setupCount == 1
    sellSetupBar1Idx  := bar_index
    sellSetupBar1High := high
if isBuySetup and setupCount == 1
    buySetupBar1Idx := bar_index
    buySetupBar1Low := low

// Perfection check
var bool sellPerfected = false
var bool buyPerfected  = false

if sellSetupComplete
    h6 = high[3]
    h7 = high[2]
    sellPerfected := (high[1] >= h6 and high[1] >= h7) or (high >= h6 and high >= h7)
if buySetupComplete
    l6 = low[3]
    l7 = low[2]
    buyPerfected := (low[1] <= l6 and low[1] <= l7) or (low <= l6 and low <= l7)

// Consecutive counting
if sellSetupComplete
    consecutiveTop := consecutiveTop + 1
    consecutiveBot := 0
if buySetupComplete
    consecutiveBot := consecutiveBot + 1
    consecutiveTop := 0


// ─── EXTENSION STATE VARIABLES ──────────────────────────────────────────────

var int   extA_sell_count  = 0, var bool  extA_sell_active = false, var float extA_sell_close8 = na
var int   extA_buy_count   = 0, var bool  extA_buy_active  = false, var float extA_buy_close8  = na
var int   extB_sell_count  = 0, var bool  extB_sell_active = false, var float extB_sell_close8 = na
var int   extB_buy_count   = 0, var bool  extB_buy_active  = false, var float extB_buy_close8  = na
var int   extC_sell_count  = 0, var bool  extC_sell_active = false, var float extC_sell_close8 = na
var int   extC_buy_count   = 0, var bool  extC_buy_active  = false, var float extC_buy_close8  = na
var float activeSellSR     = na
var float activeBuySR      = na

if sellSetupComplete
    extA_sell_count := 0, extA_sell_active := true, extA_sell_close8 := na
    extB_sell_count := 0, extB_sell_active := true, extB_sell_close8 := na
    extC_sell_count := 0, extC_sell_active := true, extC_sell_close8 := na
    activeSellSR := sellSetupBar1High
    extA_buy_active := false, extB_buy_active := false, extC_buy_active := false

if buySetupComplete
    extA_buy_count := 0, extA_buy_active := true, extA_buy_close8 := na
    extB_buy_count := 0, extB_buy_active := true, extB_buy_close8 := na
    extC_buy_count := 0, extC_buy_active := true, extC_buy_close8 := na
    activeBuySR := buySetupBar1Low
    extA_sell_active := false, extB_sell_active := false, extC_sell_active := false


// ─── EXTENSION A ────────────────────────────────────────────────────────────

extA_sell_hit = false
if extA_sell_active and close > high[2]
    extA_sell_count := extA_sell_count + 1
    extA_sell_hit   := true
    if extA_sell_count == 8
        extA_sell_close8 := close

extA_sell_complete = false
extA_sell_deferred = false
if extA_sell_active and extA_sell_count == 13
    if not na(extA_sell_close8) and close > extA_sell_close8
        extA_sell_complete := true
        extA_sell_active   := false
    else
        extA_sell_deferred := true
        extA_sell_count    := extA_sell_count - 1

extA_buy_hit = false
if extA_buy_active and close < low[2]
    extA_buy_count := extA_buy_count + 1
    extA_buy_hit   := true
    if extA_buy_count == 8
        extA_buy_close8 := close

extA_buy_complete = false
extA_buy_deferred = false
if extA_buy_active and extA_buy_count == 13
    if not na(extA_buy_close8) and close < extA_buy_close8
        extA_buy_complete := true
        extA_buy_active   := false
    else
        extA_buy_deferred := true
        extA_buy_count    := extA_buy_count - 1

if extA_sell_active and not na(activeSellSR) and close < activeSellSR
    extA_sell_active := false
if extA_buy_active and not na(activeBuySR) and close > activeBuySR
    extA_buy_active := false


// ─── EXTENSION B ────────────────────────────────────────────────────────────

extB_sell_hit = false
if extB_sell_active and close > close[2]
    extB_sell_count := extB_sell_count + 1
    extB_sell_hit   := true
    if extB_sell_count == 8
        extB_sell_close8 := close

extB_sell_complete = false
extB_sell_deferred = false
if extB_sell_active and extB_sell_count == 13
    if not na(extB_sell_close8) and high >= extB_sell_close8
        extB_sell_complete := true
        extB_sell_active   := false
    else
        extB_sell_deferred := true
        extB_sell_count    := extB_sell_count - 1

extB_buy_hit = false
if extB_buy_active and close < close[2]
    extB_buy_count := extB_buy_count + 1
    extB_buy_hit   := true
    if extB_buy_count == 8
        extB_buy_close8 := close

extB_buy_complete = false
extB_buy_deferred = false
if extB_buy_active and extB_buy_count == 13
    if not na(extB_buy_close8) and low <= extB_buy_close8
        extB_buy_complete := true
        extB_buy_active   := false
    else
        extB_buy_deferred := true
        extB_buy_count    := extB_buy_count - 1

if extB_sell_active and not na(activeSellSR) and close < activeSellSR
    extB_sell_active := false
if extB_buy_active and not na(activeBuySR) and close > activeBuySR
    extB_buy_active := false


// ─── EXTENSION C ────────────────────────────────────────────────────────────

extC_sell_hit = false
extC_sell_cond = extC_sell_active and close > high[2] and close > close[1]
extC_sell_cond := extC_sell_cond and (extC_sell_count >= 10 or high > high[1])
if extC_sell_active and extC_sell_count == 0 and close > high[2]
    extC_sell_cond := true

if extC_sell_cond
    extC_sell_count := extC_sell_count + 1
    extC_sell_hit   := true
    if extC_sell_count == 8
        extC_sell_close8 := close

extC_sell_complete = false
extC_sell_deferred = false
if extC_sell_active and extC_sell_count == 13
    if not na(extC_sell_close8) and high >= extC_sell_close8
        extC_sell_complete := true
        extC_sell_active   := false
    else
        extC_sell_deferred := true
        extC_sell_count    := extC_sell_count - 1

extC_buy_hit = false
extC_buy_cond = extC_buy_active and close < low[2] and close < close[1]
extC_buy_cond := extC_buy_cond and (extC_buy_count >= 10 or low < low[1])
if extC_buy_active and extC_buy_count == 0 and close < low[2]
    extC_buy_cond := true

if extC_buy_cond
    extC_buy_count := extC_buy_count + 1
    extC_buy_hit   := true
    if extC_buy_count == 8
        extC_buy_close8 := close

extC_buy_complete = false
extC_buy_deferred = false
if extC_buy_active and extC_buy_count == 13
    if not na(extC_buy_close8) and low <= extC_buy_close8
        extC_buy_complete := true
        extC_buy_active   := false
    else
        extC_buy_deferred := true
        extC_buy_count    := extC_buy_count - 1

if extC_sell_active and not na(activeSellSR) and close < activeSellSR
    extC_sell_active := false
if extC_buy_active and not na(activeBuySR) and close > activeBuySR
    extC_buy_active := false


// ─── SUPPORT / RESISTANCE / BREAKOUT LINES (ARRAY-MANAGED) ─────────────────

var array<line> srLines      = array.new<line>()
var array<line> breakLines   = array.new<line>()
var float lastResLevel       = na
var float lastSupLevel       = na
var bool  resBroken          = false
var bool  supBroken          = false

addLine(array<line> arr, line ln, int maxCount) =>
    array.push(arr, ln)
    while array.size(arr) > maxCount
        old = array.shift(arr)
        line.delete(old)

// Resistance line on sell setup completion (red dotted)
if sellSetupComplete and showSRLines
    newLine = line.new(sellSetupBar1Idx, sellSetupBar1High, bar_index, sellSetupBar1High, color=srResColor, style=line.style_dotted, width=1, extend=extend.right)
    addLine(srLines, newLine, maxLines)
    lastResLevel := sellSetupBar1High
    resBroken    := false

// Support line on buy setup completion (green dotted)
if buySetupComplete and showSRLines
    newLine = line.new(buySetupBar1Idx, buySetupBar1Low, bar_index, buySetupBar1Low, color=srSupColor, style=line.style_dotted, width=1, extend=extend.right)
    addLine(srLines, newLine, maxLines)
    lastSupLevel := buySetupBar1Low
    supBroken    := false

// Breakout lines (blue solid) when price breaks S/R
if showBreakout and not na(lastResLevel) and close > lastResLevel and not resBroken
    newLine = line.new(bar_index, lastResLevel, bar_index + 1, lastResLevel, color=breakoutColorC, style=line.style_solid, width=2, extend=extend.right)
    addLine(breakLines, newLine, maxLines)
    resBroken := true

if showBreakout and not na(lastSupLevel) and close < lastSupLevel and not supBroken
    newLine = line.new(bar_index, lastSupLevel, bar_index + 1, lastSupLevel, color=breakoutColorC, style=line.style_solid, width=2, extend=extend.right)
    addLine(breakLines, newLine, maxLines)
    supBroken := true


// ─── ORANGE WARNING ON BAR 8 ───────────────────────────────────────────────

// Bar 8 warning: orange arrow that signals a potential MRI completion on next bar
// In the original MRI, this appears as an orange triangle on bar 8
isBar8Sell = isSellSetup and setupCount == 8
isBar8Buy  = isBuySetup  and setupCount == 8

// Use plotshape for proper filled triangle arrows on bar 8
plotshape(showWarning and isBar8Sell, title="Sell Warning Bar 8", location=location.abovebar, style=shape.triangledown, color=warnColor, size=size.tiny)
plotshape(showWarning and isBar8Buy, title="Buy Warning Bar 8", location=location.belowbar, style=shape.triangleup, color=warnColor, size=size.tiny)


// ─── MRI TOP/BOTTOM SIGNALS (BAR 9) WITH PLOTSHAPE ─────────────────────────

// Use plotshape for proper filled triangle arrows matching original MRI
plotshape(showSignals and sellSetupComplete, title="MRI Top", location=location.abovebar, style=shape.triangledown, color=topArrowColor, size=size.small)
plotshape(showSignals and buySetupComplete, title="MRI Bottom", location=location.belowbar, style=shape.triangleup, color=botArrowColor, size=size.small)


// ─── PLOT SETUP NUMBERS ────────────────────────────────────────────────────

// Setup counts 1-7 as small labels
if showSetupNums and setupCount >= 1 and setupCount <= 7
    label.new(bar_index, isSellSetup ? high : low, str.tostring(setupCount), color=color.new(color.white, 100), textcolor=isSellSetup ? sellNumColor : buyNumColor, style=isSellSetup ? label.style_label_down : label.style_label_up, size=size.tiny)

// Bar 8: show "8" number (warning arrow is separate via plotshape above)
if showSetupNums and setupCount == 8
    label.new(bar_index, isSellSetup ? high : low, "8", color=color.new(color.white, 100), textcolor=isSellSetup ? sellNumColor : buyNumColor, style=isSellSetup ? label.style_label_down : label.style_label_up, size=size.tiny)

// Bar 9: build combined label text (e.g. "9", "C9", "2\n9" for consecutive)
if sellSetupComplete and showSetupNums
    sellTxt = ""
    // Check if any extension also fires on this same bar — combine as "C9", "B9", etc.
    hasExtOnBar = false
    extLetter = ""
    if showExtC and extC_sell_hit and extC_sell_active
        hasExtOnBar := true
        extLetter := "C"
    else if showExtB and extB_sell_hit and extB_sell_active
        hasExtOnBar := true
        extLetter := "B"
    else if showExtA and extA_sell_hit and extA_sell_active
        hasExtOnBar := true
        extLetter := "A"
    if hasExtOnBar
        sellTxt := extLetter + "9"
    else
        sellTxt := "9"
    // Prepend consecutive count if > 1
    if showConsCount and consecutiveTop > 1
        sellTxt := str.tostring(consecutiveTop) + "\n" + sellTxt
    label.new(bar_index, high, sellTxt, color=color.new(color.white, 100), textcolor=sellNumColor, style=label.style_label_down, size=size.tiny)

if buySetupComplete and showSetupNums
    buyTxt = ""
    hasExtOnBar = false
    extLetter = ""
    if showExtC and extC_buy_hit and extC_buy_active
        hasExtOnBar := true
        extLetter := "C"
    else if showExtB and extB_buy_hit and extB_buy_active
        hasExtOnBar := true
        extLetter := "B"
    else if showExtA and extA_buy_hit and extA_buy_active
        hasExtOnBar := true
        extLetter := "A"
    if hasExtOnBar
        buyTxt := extLetter + "9"
    else
        buyTxt := "9"
    if showConsCount and consecutiveBot > 1
        buyTxt := buyTxt + "\n" + str.tostring(consecutiveBot)
    label.new(bar_index, low, buyTxt, color=color.new(color.white, 100), textcolor=buyNumColor, style=label.style_label_up, size=size.tiny)


// ─── PLOT EXTENSION LABELS ──────────────────────────────────────────────────

// Skip extension label on bar 9 if it was already combined into "C9"/"B9"/"A9"
sellBar9ExtHandled = sellSetupComplete and showSetupNums
buyBar9ExtHandled  = buySetupComplete  and showSetupNums

// Extension A
if showExtA and extA_sell_hit and extA_sell_active and not (sellBar9ExtHandled)
    label.new(bar_index, high, str.tostring(extA_sell_count), color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_down, size=size.tiny)
if showExtA and extA_sell_complete
    label.new(bar_index, high, "A", color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_down, size=size.tiny)
if showExtA and extA_sell_deferred
    label.new(bar_index, high, "+", color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_down, size=size.tiny)
if showExtA and extA_buy_hit and extA_buy_active and not (buyBar9ExtHandled)
    label.new(bar_index, low, str.tostring(extA_buy_count), color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_up, size=size.tiny)
if showExtA and extA_buy_complete
    label.new(bar_index, low, "A", color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_up, size=size.tiny)
if showExtA and extA_buy_deferred
    label.new(bar_index, low, "+", color=color.new(color.white, 100), textcolor=extAColor, style=label.style_label_up, size=size.tiny)

// Extension B
if showExtB and extB_sell_hit and extB_sell_active and not (sellBar9ExtHandled)
    label.new(bar_index, high, str.tostring(extB_sell_count), color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_down, size=size.tiny)
if showExtB and extB_sell_complete
    label.new(bar_index, high, "B", color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_down, size=size.tiny)
if showExtB and extB_sell_deferred
    label.new(bar_index, high, "+", color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_down, size=size.tiny)
if showExtB and extB_buy_hit and extB_buy_active and not (buyBar9ExtHandled)
    label.new(bar_index, low, str.tostring(extB_buy_count), color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_up, size=size.tiny)
if showExtB and extB_buy_complete
    label.new(bar_index, low, "B", color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_up, size=size.tiny)
if showExtB and extB_buy_deferred
    label.new(bar_index, low, "+", color=color.new(color.white, 100), textcolor=extBColor, style=label.style_label_up, size=size.tiny)

// Extension C
if showExtC and extC_sell_hit and extC_sell_active and not (sellBar9ExtHandled)
    label.new(bar_index, high, str.tostring(extC_sell_count), color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_down, size=size.tiny)
if showExtC and extC_sell_complete
    label.new(bar_index, high, "C", color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_down, size=size.tiny)
if showExtC and extC_sell_deferred
    label.new(bar_index, high, "+", color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_down, size=size.tiny)
if showExtC and extC_buy_hit and extC_buy_active and not (buyBar9ExtHandled)
    label.new(bar_index, low, str.tostring(extC_buy_count), color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_up, size=size.tiny)
if showExtC and extC_buy_complete
    label.new(bar_index, low, "C", color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_up, size=size.tiny)
if showExtC and extC_buy_deferred
    label.new(bar_index, low, "+", color=color.new(color.white, 100), textcolor=extCColor, style=label.style_label_up, size=size.tiny)


// ─── MULTI-TIMEFRAME MRI (TABLE AT BOTTOM-RIGHT) ──────────────────────────

mriCalc() =>
    _bull = close > close[4]
    _bear = close < close[4]
    var int _count = 0
    var bool _isSell = false
    var bool _isBuy  = false
    var int _consTop = 0
    var int _consBot = 0

    if _bull
        if _isSell
            _count := _count + 1
        else
            _count  := 1
            _isSell := true
            _isBuy  := false
    else if _bear
        if _isBuy
            _count := _count + 1
        else
            _count  := 1
            _isBuy  := true
            _isSell := false
    else
        _count  := 0
        _isSell := false
        _isBuy  := false

    if _isSell and _count == 9
        _consTop := _consTop + 1
        _consBot := 0
    if _isBuy and _count == 9
        _consBot := _consBot + 1
        _consTop := 0

    [_count, _isSell ? 1 : 0, _isBuy ? 1 : 0, _consTop, _consBot]

[mtf1h_count, mtf1h_sell, mtf1h_buy, mtf1h_ctop, mtf1h_cbot] = request.security(syminfo.tickerid, "60",  mriCalc())
[mtf1d_count, mtf1d_sell, mtf1d_buy, mtf1d_ctop, mtf1d_cbot] = request.security(syminfo.tickerid, "1D",  mriCalc())
[mtf1w_count, mtf1w_sell, mtf1w_buy, mtf1w_ctop, mtf1w_cbot] = request.security(syminfo.tickerid, "1W",  mriCalc())
[mtf1m_count, mtf1m_sell, mtf1m_buy, mtf1m_ctop, mtf1m_cbot] = request.security(syminfo.tickerid, "1M",  mriCalc())
[mtf1y_count, mtf1y_sell, mtf1y_buy, mtf1y_ctop, mtf1y_cbot] = request.security(syminfo.tickerid, "12M", mriCalc())
[mtfC1_count, mtfC1_sell, mtfC1_buy, mtfC1_ctop, mtfC1_cbot] = request.security(syminfo.tickerid, customTF1, mriCalc())
[mtfC2_count, mtfC2_sell, mtfC2_buy, mtfC2_ctop, mtfC2_cbot] = request.security(syminfo.tickerid, customTF2, mriCalc())
[mtfC3_count, mtfC3_sell, mtfC3_buy, mtfC3_ctop, mtfC3_cbot] = request.security(syminfo.tickerid, customTF3, mriCalc())

// MTF table — bottom-right like the original MRI
var table mtfTable = table.new(position.bottom_right, 2, 10, bgcolor=color.new(color.black, 80), border_width=0, frame_width=0)

mtfRow(int row, string tfLabel, int count, int isSell, int isBuy, int consTop, int consBot) =>
    if count == 9
        consVal = isSell == 1 ? consTop : consBot
        clr = isSell == 1 ? color.red : #00CC00
        table.cell(mtfTable, 0, row, tfLabel, text_color=color.white, text_size=size.tiny, text_halign=text.align_right)
        table.cell(mtfTable, 1, row, str.tostring(consVal), text_color=clr, text_size=size.tiny, text_halign=text.align_left)
        true
    else
        false

if showMTF and barstate.islast
    // Clear table
    for i = 0 to 9
        table.cell(mtfTable, 0, i, "", text_size=size.tiny)
        table.cell(mtfTable, 1, i, "", text_size=size.tiny)
    row = 0
    if show1H
        if mtfRow(row, "1H", mtf1h_count, mtf1h_sell, mtf1h_buy, mtf1h_ctop, mtf1h_cbot)
            row := row + 1
    if show1D
        if mtfRow(row, "1D", mtf1d_count, mtf1d_sell, mtf1d_buy, mtf1d_ctop, mtf1d_cbot)
            row := row + 1
    if show1W
        if mtfRow(row, "1W", mtf1w_count, mtf1w_sell, mtf1w_buy, mtf1w_ctop, mtf1w_cbot)
            row := row + 1
    if show1M
        if mtfRow(row, "1M", mtf1m_count, mtf1m_sell, mtf1m_buy, mtf1m_ctop, mtf1m_cbot)
            row := row + 1
    if show1Y
        if mtfRow(row, "12M", mtf1y_count, mtf1y_sell, mtf1y_buy, mtf1y_ctop, mtf1y_cbot)
            row := row + 1
    if showCustomTF1
        if mtfRow(row, customTF1, mtfC1_count, mtfC1_sell, mtfC1_buy, mtfC1_ctop, mtfC1_cbot)
            row := row + 1
    if showCustomTF2
        if mtfRow(row, customTF2, mtfC2_count, mtfC2_sell, mtfC2_buy, mtfC2_ctop, mtfC2_cbot)
            row := row + 1
    if showCustomTF3
        if mtfRow(row, customTF3, mtfC3_count, mtfC3_sell, mtfC3_buy, mtfC3_ctop, mtfC3_cbot)
            row := row + 1


// ─── STATUS LINE ────────────────────────────────────────────────────────────

var table statusTbl = table.new(position.top_left, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)

candleDesc(int count) =>
    count == 1 ? "1st Candle" : count == 9 ? "Last Candle" : count == 8 ? "Prior Candle" : "None"

currentCandleDesc = setupCount >= 1 ? candleDesc(setupCount) : "None"
priorCandleDesc   = setupCount >= 2 ? candleDesc(setupCount - 1) : "None"

mtfStatusParts = ""
if show1D and mtf1d_count == 9
    mtfStatusParts := mtfStatusParts + " " + str.tostring(mtf1d_ctop > 0 ? mtf1d_ctop : mtf1d_cbot) + " Day(s)"
if show1W and mtf1w_count == 9
    mtfStatusParts := mtfStatusParts + " " + str.tostring(mtf1w_ctop > 0 ? mtf1w_ctop : mtf1w_cbot) + " Week(s)"
if show1M and mtf1m_count == 9
    mtfStatusParts := mtfStatusParts + " " + str.tostring(mtf1m_ctop > 0 ? mtf1m_ctop : mtf1m_cbot) + " Month(s)"

statusText = "MRI " + extMode + " " + currentCandleDesc + " " + priorCandleDesc + mtfStatusParts
table.cell(statusTbl, 0, 0, statusText, text_color=color.gray, text_size=size.small)


// ─── ALERTS ─────────────────────────────────────────────────────────────────

alertcondition(sellSetupComplete, title="MRI Top", message="MRI Top — Bullish trend may be ending")
alertcondition(buySetupComplete, title="MRI Bottom", message="MRI Bottom — Bearish trend may be ending")
alertcondition(isSellSetup and setupCount == 8, title="MRI Warning (Sell)", message="MRI Warning — Potential top on next candle")
alertcondition(isBuySetup and setupCount == 8, title="MRI Warning (Buy)", message="MRI Warning — Potential bottom on next candle")
alertcondition(extA_sell_complete or extA_buy_complete, title="Extension A Complete", message="MRI Extension A completed")
alertcondition(extB_sell_complete or extB_buy_complete, title="Extension B Complete", message="MRI Extension B completed")
alertcondition(extC_sell_complete or extC_buy_complete, title="Extension C Complete", message="MRI Extension C completed")
alertcondition(consecutiveTop >= 2 and sellSetupComplete, title="Consecutive MRI Top", message="Consecutive MRI Top — Strong reversal signal")
alertcondition(consecutiveBot >= 2 and buySetupComplete, title="Consecutive MRI Bottom", message="Consecutive MRI Bottom — Strong reversal signal")
